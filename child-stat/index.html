<!doctype html>
<html>
  <head>
    <title>Child stat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="https://www.dropbox.com/static/api/dropbox-datastores-1.0-latest.js"></script>
  </head>
  <body>
    <h1>Click the stat</h1>

    <div id="container">
      <button id="login" style="display:none">Log in with Dropbox</button>
      <button id="box" style="display:none"></button>
    </div>
    <a id="reset" href="#">&pi;</a>
    <a id="logout" href="#" style="display:none">Log out</a>

    <div class="js-date-results">

    </div>
    <div class="buttons" style="display:none;">
      <a href="#" class="js-start-sleep">start sleep</a>
      <a href="#" class="js-beep">beep</a>
      <a href="#" class="js-eat">eat</a>
    </div>

    <script>
      if (window.location.href.indexOf('http://') === 0 && window.location.host.indexOf('127.0.0.1') !== 0) {
        window.location = window.location.href.replace('http://', 'https://');
      }

      // Be sure to use your own app key so you can set up your own redirect URI.
      var APP_KEY = 'q0pa3lmetgckf2i';
      var client = new Dropbox.Client({key: APP_KEY});
      // Use a pop-up for auth.
      client.authDriver(new Dropbox.AuthDriver.Popup({receiverUrl: window.location.href + 'oauth_receiver.html'}));


      // First check if we're already authenticated.
      client.authenticate({interactive: false});

      if (client.isAuthenticated()) {
        // If we're authenticated, update the UI to reflect the logged in status.
        loggedIn();
      } else {
        // Otherwise show the login button.
        $('#login').show();
      }

      $('#login').click(function () {
        client.authenticate(function (err) {
          if (err) {
            alert('Error: ' + err);
            return;
          }
          loggedIn();
        });
      });

      function loggedIn() {
        $('#login').hide();
        $('.buttons').show();
        var dataStoreManager = new Dropbox.Datastore.dataStoreManager(client);

        dataStoreManager.openDefaultDatastore(function (err, datastore) {
            if (err) {
              alert('Error: ' + err);
              return;
            }

            // Make sure we use the "max" resolution rule to resolve conflicts about which level we're on.
            var table = datastore.getTable('child-stat-test');
//          table.setResolutionRule('level', 'max');

            $('.js-start-sleep').click(function () {
              table.insert({
                type: 'start-sleep',
                time: (new Date()).toLocaleTimeString(),
              });
            })

            datastore.recordsChanged.addListener(updateResultTable);

            var updateResultTable = function () {
              var records = table.query();
              for (var i = 0; i &lt; records.length; i++) {
                var record = records[i];
                console.log(record);
              }
            }


////          function getRecord() {
////            // Use getOrInsert to provide a default of level 0.
////            return table.getOrInsert('current_level', {level: 0});
////          }
//
//          function updateLevel() {
//            setLevel(getRecord().get('level'));
//          }

//          updateLevel();

//          // Any time there's a change, update the current level.

//
//          $('#box').click(function (e) {
//            e.preventDefault();
//
//            // Increment the level.
//            var record = getRecord();
//            record.set('level', record.get('level') + 1);
//          });
//
//          $('#reset').click(function (e) {
//            e.preventDefault();
//            // Go back to level 0.
//            getRecord().set('level', 0);
//          });

            $('#logout').show().click(function (e) {
              e.preventDefault();
              client.signOut();
              $('#login').show();
              $('#box, #instructions').hide();
              $('#container').css('padding', 0);
              $('h1').text('Click the Box');
            });
          }
        )
        ;
      }
    </script>
  </body>
</html>
